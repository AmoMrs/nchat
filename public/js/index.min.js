"use strict";var chatMsgSend=document.getElementsByClassName("chat-msg-send")[0],chatMsgSendBtn=document.getElementsByClassName("chat-send-btn")[0],chatEmojiList=document.getElementsByClassName("chat-emoji-list")[0],infoTab=document.getElementsByClassName("info-tab")[0],chatMsgList=document.getElementsByClassName("chat-msg-list")[0],chatMoreBox=document.getElementsByClassName("chat-more-box")[0],socketHostName=document.location.hostname,socketURI="http://"+socketHostName+":8087/",socket=io(socketURI),nChat={};nChat.data={isRoomInit:!1,messIsFirst:!0,messIsFoucs:!1,isInitInsertEmoji:!1,onlineUserCount:0,onlineUserList:[],onlineUserListImg:[],defaultUserImg:"https://randomuser.me/api/portraits/women/50.jpg",welcomeInfo:"系统: 欢迎来到 ",currentRoomName:null,user:{name:null,pass:null,desc:null,img:"https://randomuser.me/api/portraits/men/1.jpg",sex:"men"},robot:{api:document.location.origin+"/api/robot/openapi/api",key:"57a5b6849e2b4d47ae0badadf849c261",nick:"小美",img:"https://randomuser.me/api/portraits/women/60.jpg"}},nChat.room={init:function(){socket.on("room id req",function(){socket.emit("room id res",nChat.data.currentRoomName),nChat.method.insertToList(chatMsgList,"li",nChat.data.welcomeInfo+nChat.data.currentRoomName),chatMsgSend.value="",chatMsgSend.focus(),chatMoreBox.style.visibility="hidden",chatMsgSend.onclick=function(){chatMoreBox.style.visibility="hidden",nChat.data.messIsFoucs=!0}}),socket.on("user login req",function(t){nChat.method.insertToList(chatMsgList,"li",t)}),socket.on("user logout req",function(t){console.log(t),nChat.method.insertToList(chatMsgList,"li",t.currentUser+" 离开了房间"),nChat.method.scrollToBottom()}),socket.on("mess show res",function(t){console.log(t);for(var e=t.length,n=0;n<e;n++){var a=nChat.method.renderBubbleMsg("left",t[n].user,nChat.method.parseTime(t[n].time),nChat.method.parseMsgVal(t[n].mess),t[n].img);nChat.method.insertToList(chatMsgList,"li",a)}nChat.method.scrollToBottom()})},render:function(){socket.on("current status",function(t){console.log(t)}),socket.on("send message res",function(t){var e=nChat.method.parseTime(t.time),n=nChat.method.renderBubbleMsg("left",t.user,e,nChat.method.parseMsgVal(t.msg),t.img);nChat.method.insertToList(chatMsgList,"li",n);var a=t.length;console.log("total message / "+a),nChat.method.scrollToBottom()})}},nChat.method={getCurrentRoomName:function(){var t=document.location.pathname,e="/"===t,n=null;return e||-1===t.indexOf("room")||(n=t.replace(/\/.*?\//,"")),null===n?n="Chat Room":decodeURIComponent(n)},initList:function(t){t.innerHTML=""},renderList:function(t,e,n){for(var a={chat:chatMsgList,emoji:chatMoreBox},o=0;o<e.length;o++)this.insertToList(a[t],"li",e[o])},insertToList:function(t,e,n){var a=document.createElement(e);a.innerHTML=n,t.appendChild(a)},renderUserList:function(t,e){return'<img src="'+t+'" class="user-img">\n      <span class="user-name">'+e+"</span>"},renderBubbleMsg:function(t,e,n,a,o){var s="";return s=""!==n?'\n        <ul class="bubble-info">\n          <li class="bubble-info-user">'+e+'</li>\n          <li class="bubble-info-time">'+n+"</li>\n        </ul>":"",void 0!==o&&null!==o||(o=nChat.data.defaultUserImg),'<div class="bubble bubble-'+t+'">\n      <div class="bubble-head">\n        <img src='+o+' class="user-img">\n      </div>\n      <div class="bubble-ctx">\n        '+s+'\n        <div class="bubble-ctx-border">\n          <p class="bubble-ctx-show">'+a+"</p>\n        </div>\n      </div>\n    </div>"},parseMsgVal:function(t){var e=t.replace(/</g,"&lt;");return e=e.replace(/>/g,"&gt;")},getTime:function(t){return Date.parse(t)/1e3},parseTime:function(t){var e=new Date;return e.setTime(1e3*t),e.toLocaleString()},sendMessage:function(){if(""!==chatMsgSend.value){chatMoreBox.style.visibility="hidden";var t=nChat.method.getTime(new Date),e=null!==nChat.data.user.name?nChat.data.user.name:"神秘人",n=nChat.method.parseMsgVal(chatMsgSend.value),a=nChat.method.renderBubbleMsg("right",e,"",n,nChat.data.user.img);socket.emit("send message req",t,nChat.data.currentRoomName,{user:e,time:t,msg:n,img:nChat.data.user.img}),nChat.method.insertToList(chatMsgList,"li",a),chatMsgSend.value="",chatMsgSend.focus(),nChat.method.scrollToBottom(),"小美"===nChat.data.currentRoomName&&axios.get(nChat.data.robot.api,{params:{key:nChat.data.robot.key,info:n}}).then(function(e){var n=nChat.method.getTime(new Date),a=nChat.method.renderBubbleMsg("left",nChat.data.robot.nick,n,e.data.text,nChat.data.robot.img);nChat.method.insertToList(chatMsgList,"li",a),socket.emit("send message req",t,nChat.data.currentRoomName,{user:nChat.data.robot.nick,tm:t,msg:e.data.text,img:nChat.data.robot.img}),nChat.method.scrollToBottom()}).catch(function(t){console.log(t)})}},getOnlineList:function(t,e){t.filter(function(t){if(t.name===e){var n=t.user.concat(),a=t.img.concat();nChat.data.onlineUserCount=t.user.length,nChat.data.onlineUserList=n,nChat.data.onlineUserListImg=a}})},getRandomImg:function(t){return"https://randomuser.me/api/portraits/"+t+"/"+parseInt(100*Math.random())+".jpg"},getRandomNick:function(t,e){return"https://uinames.com/api/?region="+t+"&gender="+e+"&amount=1"},getEmoji:function(t){var e=["😅","😂","🙂","🙃","😉","😘","😗","😜","😎","😏","😔","🙁","😶","😢","🤔","👏","🤝","👍","👎","✌","❤","🐶","🐱","🐰","🐭","🐷","🐸","🙈"],n=t||chatMoreBox;this.initList(n),"hidden"===n.style.visibility?chatMoreBox.style.visibility="visible":chatMoreBox.style.visibility="hidden",this.renderList("emoji",e),!1===nChat.data.isInitInsertEmoji&&this.initInsertEmoji()},initInsertEmoji:function(){chatMoreBox.addEventListener("click",function(t){"li"===t.target.tagName.toLowerCase()&&nChat.method.insertEmojiToText(t.target.innerText)},!1),nChat.data.isInitInsertEmoji=!0},insertEmojiToText:function(t){var e=chatMsgSend.value,n=chatMsgSend.selectionStart;nChat.data.messIsFirst&&!nChat.data.messIsFoucs&&(n=e.length),nChat.data.messIsFirst=!1,""===e?chatMsgSend.value=t:e.length===n?chatMsgSend.value=chatMsgSend.value+t:chatMsgSend.value=e.slice(0,n)+t+e.slice(n,e.length),chatMsgSend.focus()},scrollToBottom:function(){var t=document.getElementsByClassName("chat-ctx")[0];t.scrollTop=t.scrollHeight}},document.body.onload=function(){nChat.data.currentRoomName=nChat.method.getCurrentRoomName(),nChat.room.init(),nChat.room.render(),console.log(nChat.method.getRandomImg("men")),console.log(nChat.method.getRandomNick("china","male")),chatMsgSendBtn.addEventListener("click",function(){nChat.method.sendMessage()},!1),chatEmojiList.addEventListener("click",function(){nChat.method.getEmoji()},!1)};